(function(){var t={},n=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this);var n=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),"connect"==t&&this._connected&&n(this._socket),this},t.removeListener=function(t,n){if(this._ev&&this._ev[t])for(var e=this._ev[t],i=0;i<e.length;i++)if(e[i]==n)return void e.splice(i,1)},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.disconnect=function(){this._socket.messageTo({disconnect:!0}),me._connected=!1},t.emit=function(t,n,e){var i={name:t,data:n};if(e){i._callBackId=this.guid();var o=this,r=function(t){e(t),o.removeListener(i._callBackId,r)};this.on(i._callBackId,r)}this._socket.messageTo(i)},t.getEnum=function(){var t=this.socketId;return n[t]||(n[t]=e++),n[t]},t.getId=function(){return this.socketId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,i,o){n||(n={},e=1);var r=this,c=this.guid();if(this.socketId=c,n[this.socketId]||(n[this.socketId]=e++),o){var a=function(){console.log("whenConnected called");var n=s(t,i,"openConnection","client",o),e=s(t,i,c,"client",o);e.on("clientMessage",function(t,n){console.log("clientMessage received ",n),n.connected?(r._socket=e,r._connected=!0,r.trigger("connect",e)):r.trigger(n.name,n.data)}),console.log("Sending message to _tcpEmu with real socket "),n.messageTo({socketId:c})};return void(o.connected?(console.log("realSocket was connected"),a()):(console.log("realSocket was not connected"),o.on("connect",a)))}var f=s(t,i,"openConnection","client",o),u=s(t,i,c,"client",o);u.on("clientMessage",function(t,n){n.connected?(r._socket=u,r._connected=!0,r.trigger("connect",u)):r.trigger(n.name,n.data)}),f.messageTo({socketId:c})}),t.send=function(t,n){var e=this;return _promise(function(i){e.emit(t,n,i)})}}(this)},e=function(t,n,i,o,r,s,c,a){var f,u=this;if(!(u instanceof e))return new e(t,n,i,o,r,s,c,a);var _=[t,n,i,o,r,s,c,a];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,_)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,o,r,s,c,a)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,_)}):"function"==typeof u.init&&u.init.apply(u,_)};e._classInfo={name:"_clientSocket"},e.prototype=new n,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._clientSocket=e,this._clientSocket=e):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._clientSocket=e:this._clientSocket=e}.call(new Function("return this")());var i=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.getPrefix=function(){return this._ip+":"+this._port},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,i,o){e||(e={},n={});var r=this;if(this._ip=t,this._port=i,o)return void o.on("connection",function(e){console.log("socket.io got connection"),console.log("ip, port",t,i);var o,c=s(t,i,"openConnection","server",e);e.on("disconnect",function(){console.log("ioLib at server sent disconnect"),o&&o.close()}),c.on("serverMessage",function(c,a){if(a.socketId){var f=s(t,i,a.socketId,"server",e);o=f;var _=u(f,r);n[a.socketId]=_,r.trigger("connect",_),_.isConnected()?(console.log("Trying to send the connected message back to client"),f.messageFrom({connected:!0,socketId:a.socketId})):console.log("The socket was not connected")}})});var c=s(t,i,"openConnection","server");c.on("serverMessage",function(e,o){if(o.socketId){var c=s(t,i,o.socketId,"server"),a=u(c,r);n[o.socketId]=a,r.trigger("connect",a),r.trigger("connection",a),a.isConnected()&&c.messageFrom({connected:!0,socketId:o.socketId})}})})}(this)},o=function(t,n,e,i,r,s,c,a){var f,u=this;if(!(u instanceof o))return new o(t,n,e,i,r,s,c,a);var _=[t,n,e,i,r,s,c,a];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,_)}),"function"==typeof f){if(f._classInfo.name!=o._classInfo.name)return new f(t,n,e,i,r,s,c,a)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,_)}):"function"==typeof u.init&&u.init.apply(u,_)};o._classInfo={name:"_serverSocket"},o.prototype=new i,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverSocket=o,this._serverSocket=o):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverSocket=o:this._serverSocket=o}.call(new Function("return this")());var r=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){var i=this;return this._ev[t].forEach(function(t){t(i,n,e)}),this}}}(this),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n,e;t.close=function(){this.trigger("disconnect")},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,i,o,r){this._server=t,this._port=n,this._role=o,this._socketId=i,this._dbName="tcp://"+this._server+":"+this._port+":"+this._socketId,e||(e="undefined"!=typeof lokki?lokki("tcp"):{log:function(){},error:function(){}}),r?(this._socket=r,this.socketPump(o)):this.memoryPump(o)}),t.memoryPump=function(t){var i=this,o=this._dbName+":to",r=this._dbName+":from";n||(n={}),n[o]||(n[o]=[]),n[r]||(n[r]=[]);var s=function(){if("server"==t){var s=n[o].slice();s.forEach(function(t){e.log("server got message ",t),i.trigger("serverMessage",t),n[o].shift()})}if("client"==t){var s=n[r].slice();s.forEach(function(t){i.trigger("clientMessage",t),n[r].shift()})}};a().every(.1,s)},t.messageFrom=function(t){var e=this._socket;if(e)return void e.emit(this._dbName,t);var i=this._dbName+":from";n[i].push(t)},t.messageTo=function(t){var i=this._socket;if(i)return e.log("_tcpEmu, emitting ",this._dbName,t),void i.emit(this._dbName,t);var o=this._dbName+":to";n[o].push(t)},t.socketPump=function(t){var n=this,i=this._socket;"server"==t&&(e.log("initializing the socketPump for server"),i.on(this._dbName,function(t){e.log("socketPump",n._dbName),n.trigger("serverMessage",t)})),"client"==t&&i.on(this._dbName,function(t){n.trigger("clientMessage",t)})}}(this)},s=function(t,n,e,i,o,r,c,a){var f,u=this;if(!(u instanceof s))return new s(t,n,e,i,o,r,c,a);var _=[t,n,e,i,o,r,c,a];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,_)}),"function"==typeof f){if(f._classInfo.name!=s._classInfo.name)return new f(t,n,e,i,o,r,c,a)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,_)}):"function"==typeof u.init&&u.init.apply(u,_)};s._classInfo={name:"_tcpEmu"},s.prototype=new r;var c=function(){!function(t){var n,e,i,o,r;t.add=function(t,n,i){if(n||i){var o;"[object Array]"===Object.prototype.toString.call(i)?o=i:(o=Array.prototype.slice.call(arguments,2),o||(o=[])),e.push([n,t,o])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),o[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,s;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},o={},r=[];var c=0,a=function(){for(var n,s=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<r.length;f++){var u=r[f];u()}for(var _ in i)if(i.hasOwnProperty(_)){var l=i[_];l[0](l[1]),delete i[_]}for(var _ in o)if(o.hasOwnProperty(_)){var l=o[_];l.nextTime<s&&(l.fn(),l.nextTime=s+l.step),l.until&&l.until<s&&delete o[_]}t(a),c=s};a(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){r.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=r.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),r.splice(n,1),!0):!1}}(this)},a=function(t,n,e,i,o,r,s,c){var f,u=this;if(!(u instanceof a))return new a(t,n,e,i,o,r,s,c);var _=[t,n,e,i,o,r,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,_)}),"function"==typeof f){if(f._classInfo.name!=a._classInfo.name)return new f(t,n,e,i,o,r,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,_)}):"function"==typeof u.init&&u.init.apply(u,_)};a._classInfo={name:"later"},a.prototype=new c;var f=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.delegateToRoom=function(t,e,i){var o=this._roomPrefix+":"+t;if(n&&n[o]){var r=this;n[o].forEach(function(t){t!=r&&t.emit(e,i)})}},t.disconnect=function(){var t=this;t._disconnected=!0,console.log("_serverSocketWrap disconnecting"),t.leaveFromRooms(),console.log("_serverSocketWrap left from rooms"),t.trigger("disconnect",t),t._disconnected=!0},t.emit=function(t,n){this._tcp.messageFrom({name:t,data:n})},t.getId=function(){return this._tcp._socketId},t.getUserId=function(){return this._userId},t.getUserRoles=function(){return this._roles},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){var e=this;this._roomPrefix=n.getPrefix(),this._server=n,this._tcp=t,t.on("disconnect",function(){console.log("tcpEmu sent disconnect"),e.disconnect()});t.on("serverMessage",function(t,n){return e._disconnected?void 0:n.disconnect?void e.disconnect():void(n._callBackId?e.trigger(n.name,n.data,function(t){e.emit(n._callBackId,t)}):e.trigger(n.name,n.data))}),this.broadcast={to:function(t){return{emit:function(n,i){e.delegateToRoom(t,n,i)}}}}}),t.isConnected=function(){return this._disconnected?!1:!0},t.isInRoom=function(t){return e?e[this.getId()].indexOf(t)>=0:!1},t.join=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]),n[i].indexOf(this)<0&&(n[i].push(this),e||(e={}),e[this.getId()]||(e[this.getId()]=[]),e[this.getId()].push(t))},t.leave=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]);var o;if((o=n[i].indexOf(this))>=0){n[i].splice(o,1);var r=this.getId(),s=e[r].indexOf(t);s>=0&&e[r].splice(s,1)}},t.leaveFromRooms=function(){var t=this.getId(),n=this;e&&e[t]&&e[t].forEach(function(t){n.leave(t)})},t.removeListener=function(){},t.setAuthInfo=function(t,n){this._userId=t,this._roles=n},t.to=function(t){var e=this._roomPrefix+":"+t;return{emit:function(t,i){console.log(" emit called "),n&&n[e]&&n[e].forEach(function(n){console.log(" emit with ",t,i),n.emit(t,i)})}}}}(this)},u=function(t,n,e,i,o,r,s,c){var a,f=this;if(!(f instanceof u))return new u(t,n,e,i,o,r,s,c);var _=[t,n,e,i,o,r,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){a=t.apply(f,_)}),"function"==typeof a){if(a._classInfo.name!=u._classInfo.name)return new a(t,n,e,i,o,r,s,c)}else if(a)return a;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,_)}):"function"==typeof f.init&&f.init.apply(f,_)};u._classInfo={name:"_serverSocketWrap"},u.prototype=new f,function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},e=function(t,n,i,o,r,s,c,a){var f,u=this;if(!(u instanceof e))return new e(t,n,i,o,r,s,c,a);var _=[t,n,i,o,r,s,c,a];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,_)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,o,r,s,c,a)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,_)}):"function"==typeof u.init&&u.init.apply(u,_)};e._classInfo={name:"socketEmulator"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());
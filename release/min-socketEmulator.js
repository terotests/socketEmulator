var _socketEmu_prototype=function(){"use strict";var t=function(){var t=function(){!function(t){var n,e,i,o,r;t.add=function(t,n,i){if(n||i){var o;"[object Array]"===Object.prototype.toString.call(i)?o=i:(o=Array.prototype.slice.call(arguments,2),o||(o=[])),e.push([n,t,o])}else e.push(t)},t.after=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),o[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),o[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){this.polyfill();var t,s;if("undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},o={},r=[];var a=0,c=function(){for(var n,s=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<r.length;f++){var u=r[f];u()}for(var h in i)if(i.hasOwnProperty(h)){var _=i[h];_[0](_[1]),delete i[h]}for(var h in o)if(o.hasOwnProperty(h)){var _=o[h];_.nextTime<s&&(_.remove?_.nextTime>0?(_.fn(),delete o[h]):_.nextTime=s+_.step:(_.fn(),_.nextTime=s+_.step)),_.until&&_.until<s&&delete o[h]}t(c),a=s};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){r.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=r.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),r.splice(n,1),!0):!1}}(this)},e=function(t,n,i,o,r,s,a,c){if(!(this instanceof e))return new e(t,n,i,o,r,s,a,c);var f=[t,n,i,o,r,s,a,c];if(this.__factoryClass){var u,h=this;if(this.__factoryClass.forEach(function(t){u=t.apply(h,f)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,o,r,s,a,c)}else if(u)return u}if(this.__traitInit){var h=this;this.__traitInit.forEach(function(t){t.apply(h,f)})}else"function"==typeof this.init&&this.init.apply(this,f)};e._classInfo={name:"later"},e.prototype=new t,"undefined"!=typeof window&&(window.later=e),"undefined"!=typeof window&&(window.later_prototype=t),function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var e;e=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var i=e.length,o=0,r=[],s=new Array(i);return this.then(function(){var t=n();return 0==e.length&&t.resolve([]),e.forEach(function(n,e){n.then?(r.push(n),n.then(function(n){s[e]=n,o++,o==i&&t.resolve(s)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,e,i){var o;o=this.isArray(e)?e:[e];var r=o.length,s=!1,a=!1,c=0,f=[],u=i||{};return this.then(function(){var e=n();return o.forEach(function(n){n.then?(f.push(n),n.then(function(n){c++,s=t(n,u),(s&&!a||0==a&&r==c)&&(e.resolve(u),a=!0)},function(t){e.reject(t)})):e.reject("Not list of promises")}),e})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(o){e.reject(o)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.genPlugin=function(t,e){this.plugin(t,function(){var t=Array.prototype.slice.call(arguments,0);console.log("Plugin args",t);var i=n();return this.then(function(){var n=Array.prototype.slice.call(arguments,0),o=t.concat(n),r=e.apply(this,o);i.resolve(r)},function(t){i.reject(t)}),i})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){console.log("--- calling the onFulfilled "),t(function(t){i.resolve(t)},function(t){i.resolve(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.nodeStyle=function(t,n){this.plugin(t,function(){var t,e,i=Array.prototype.slice.call(arguments,0),o=0;i.length>=0&&(t=i[i.length-1],"[object Function]"==Object.prototype.toString.call(t)&&(e=t,o=i.length-1));var r=wishes().pending();return this.then(function(){var t=wishes().pending(),s=Array.prototype.slice.call(arguments,0);console.log("Orig args",i),console.log("Then args",s);var a;0==i.length&&(a=s),0==s.length&&(a=i),a||(a=s.concat(i)),o=a.length,e&&o--,a[o]=function(n){if(n)return console.log("Got error ",n),t.reject(n),void r.reject(n);if(e){var i=Array.prototype.slice.call(arguments),o=e.apply(this,i);r.resolve(o)}else{var i=Array.prototype.slice.call(arguments,1);r.resolve.apply(r,i)}},t.then(function(t){r.resolve(t)}),console.log("nodeStyle after concat",a);n.apply(this,a);return t},function(t){r.reject(t)}),r})},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.plugin=function(n,e){return t[n]=e,this},t.props=function(t){var n=[];for(var e in t)t.hasOwnProperty(e)&&n.push({name:e,promise:t[e]});var i=n.length,o=0,r=[],s={};return this.then(function(){var t=wishes().pending();return n.forEach(function(n){var e=n.promise,a=n.name;e.then?(r.push(e),e.then(function(n){s[a]=n,o++,o==i&&t.resolve(s)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,i){i||(i=function(){});var o=new n(t,i),r=this;return 1==this._state&&e().asap(function(){r.fulfill(r.value())}),2==this._state&&ater().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(o),o},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},n=function(t,e,i,o,r,s,a,c){if(!(this instanceof n))return new n(t,e,i,o,r,s,a,c);var f=[t,e,i,o,r,s,a,c];if(this.__factoryClass){var u,h=this;if(this.__factoryClass.forEach(function(t){u=t.apply(h,f)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=n._classInfo.name)return new u(t,e,i,o,r,s,a,c)}else if(u)return u}if(this.__traitInit){var h=this;this.__traitInit.forEach(function(t){t.apply(h,f)})}else"function"==typeof this.init&&this.init.apply(this,f)};n._classInfo={name:"_promise"},n.prototype=new t,"undefined"!=typeof window&&(window._promise=n),"undefined"!=typeof window&&(window._promise_prototype=t);var e=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){t.disconnect=function(){this._socket.messageTo({disconnect:!0})},t.emit=function(t,n){this._socket.messageTo({name:t,data:n})},t.getId=function(){return this.socketId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){var i=e||this.guid(),o=this,r=f(t,n,"openConnection","client"),s=f(t,n,i,"client");this.socketId=i,s.on("clientMessage",function(t,n){n.connected?(o._socket=s,o.trigger("connect",s)):o.trigger(n.name,n.data)}),r.messageTo({socketId:i})}),t.removeListener=function(){}}(this)},i=function(t,n,e,o,r,s,a,c){if(!(this instanceof i))return new i(t,n,e,o,r,s,a,c);var f=[t,n,e,o,r,s,a,c];if(this.__factoryClass){var u,h=this;if(this.__factoryClass.forEach(function(t){u=t.apply(h,f)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=i._classInfo.name)return new u(t,n,e,o,r,s,a,c)}else if(u)return u}if(this.__traitInit){var h=this;this.__traitInit.forEach(function(t){t.apply(h,f)})}else"function"==typeof this.init&&this.init.apply(this,f)};i._classInfo={name:"_clientSocket"},i.prototype=new e,"undefined"!=typeof window&&(window._clientSocket=i),"undefined"!=typeof window&&(window._clientSocket_prototype=e);var o=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.emit=function(){},t.getPrefix=function(){return this._ip+":"+this._port},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,i){e||(e={},n={});var o=this;this._ip=t,this._port=i;var r=f(t,i,"openConnection","server");r.on("serverMessage",function(e,r){if(r.socketId){var s=f(t,i,r.socketId,"server"),a=l(s,this);n[r.socketId]=a,o.trigger("connect",a),a.isConnected()&&s.messageFrom({connected:!0,socketId:r.socketId})}})}),t.join=function(){},t.removeListener=function(){}}(this)},r=function(t,n,e,i,o,s,a,c){if(!(this instanceof r))return new r(t,n,e,i,o,s,a,c);var f=[t,n,e,i,o,s,a,c];if(this.__factoryClass){var u,h=this;if(this.__factoryClass.forEach(function(t){u=t.apply(h,f)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=r._classInfo.name)return new u(t,n,e,i,o,s,a,c)}else if(u)return u}if(this.__traitInit){var h=this;this.__traitInit.forEach(function(t){t.apply(h,f)})}else"function"==typeof this.init&&this.init.apply(this,f)};r._classInfo={name:"_serverSocket"},r.prototype=new o,"undefined"!=typeof window&&(window._serverSocket=r),"undefined"!=typeof window&&(window._serverSocket_prototype=o);var s=function(){var t=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){t.addRows=function(t){var e=n(),i=this._db.transaction([this._table],"readwrite");i.oncomplete=function(){e.resolve(!0)},i.onerror=function(){};var o=i.objectStore(this._table);for(var r in t){var s=o.add(t[r]);s.onsuccess=function(){}}return console.log("About to add the rows to the table "),e},t.count=function(){var t=n(),e=this._db.transaction([this._table],"readonly");return e.objectStore(this._table).count().onsuccess=function(n){t.resolve(n.target.result)},t},t.forEach=function(t){var n=this._db.transaction(this._table,"readwrite"),e=n.objectStore(this._table);n.oncomplete=function(){};var i=e.openCursor();i.onerror=function(t){console.log(t)},i.onsuccess=function(n){var e=n.target.result;e&&(t(e.value,e),e.continue())}},t.get=function(t){var e=n(),i=db.transaction([this._table]),o=i.objectStore(this._table),r=o.get(t);return r.onerror=function(t){e.fail(t.target.errorCode)},r.onsuccess=function(){e.resolve(r.result.name)},e},t.getAll=function(){var t=n(),e=this._db.transaction(this._table,"readonly"),i=e.objectStore(this._table),o=[];e.oncomplete=function(){t.resolve(o)};var r=i.openCursor();return r.onerror=function(t){console.log(t)},r.onsuccess=function(t){var n=t.target.result;n&&(o.push(n.value),n.continue())},t},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._db=t,this._table=n}),t.readAndDelete=function(){var t=n(),e=this._db.transaction(this._table,"readwrite"),i=e.objectStore(this._table),o=[];e.oncomplete=function(){t.resolve(o)};var r=i.openCursor();return r.onerror=function(t){console.log(t)},r.onsuccess=function(t){var n=t.target.result;n&&(o.push(n.value),n.delete(),n.continue())},t}}(this)},e=function(t,n,i,o,r,s,a,c){if(!(this instanceof e))return new e(t,n,i,o,r,s,a,c);var f=[t,n,i,o,r,s,a,c];if(this.__factoryClass){var u,h=this;if(this.__factoryClass.forEach(function(t){u=t.apply(h,f)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,o,r,s,a,c)}else if(u)return u}if(this.__traitInit){var h=this;this.__traitInit.forEach(function(t){t.apply(h,f)})}else"function"==typeof this.init&&this.init.apply(this,f)};e._classInfo={name:"dbTable"},e.prototype=new t,"undefined"!=typeof window&&(window.dbTable=e),"undefined"!=typeof window&&(window.dbTable_prototype=t),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var n,i,o,r,s;t._initDB=function(){r||(n=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,i=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,o=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,r=!0,s=a("sys.db",{tables:{databases:{createOptions:{keyPath:"name"}}}}))},t.clearDatabases=function(t){s.then(function(){var e=s.table("databases");e.forEach(function(e,i){t(e)&&(n.deleteDatabase(e.name),i.delete())})})},t.createTable=function(t,n){this._db.createObjectStore(t,n)},t.getStore=function(t,n){var e=this._db.transaction(t,n);return e.objectStore(t)},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e){if(!this._db&&(this._initDB(),t)){var i=this,o=n.open(t,4);o.onerror=function(t){console.error(t.target.errorCode)},o.onsuccess=function(n){if(s.then(function(){var n=s.table("databases");n.addRows([{name:t}])}),i._db=n.target.result,e&&e.tables)for(var o in e.tables)if(e.tables.hasOwnProperty(o)){var r=e.tables[o];try{{i._db.createObjectStore(o,r.createOptions)}}catch(a){}}i.resolve(!0)},o.onupgradeneeded=function(t){var n=t.target.result;if(i._db=n,e&&e.tables)for(var o in e.tables)if(e.tables.hasOwnProperty(o)){var r=e.tables[o];n.createObjectStore(o,r.createOptions)}}}}),t.table=function(t){return e(this._db,t)}}(this)};s.prototype=n.prototype;var a=function(t,n,e,i,o,r,s,c){if(!(this instanceof a))return new a(t,n,e,i,o,r,s,c);var f=[t,n,e,i,o,r,s,c];if(this.__factoryClass){var u,h=this;if(this.__factoryClass.forEach(function(t){u=t.apply(h,f)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=a._classInfo.name)return new u(t,n,e,i,o,r,s,c)}else if(u)return u}if(this.__traitInit){var h=this;this.__traitInit.forEach(function(t){t.apply(h,f)})}else"function"==typeof this.init&&this.init.apply(this,f)};a._classInfo={name:"_localDB"},a.prototype=new s,"undefined"!=typeof window&&(window._localDB=a),"undefined"!=typeof window&&(window._localDB_prototype=s);var c=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){var i=this;return this._ev[t].forEach(function(t){t(i,n,e)}),this}}}(this),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e,i){var o=this;this._server=t,this._port=n,this._socketId=e,this._dbName="tcp://"+this._server+":"+this._port+":"+this._socketId,this._db=a("tcp://"+this._server+":"+this._port+":"+this._socketId,{tables:{messagesTo:{createOptions:{autoIncrement:!0}},messagesFrom:{createOptions:{autoIncrement:!0}}}}),h().every(.1,function(){o._db.then(function(){"server"==i&&o._db.table("messagesTo").readAndDelete().then(function(t){t.forEach(function(t){o.trigger("serverMessage",t)})}),"client"==i&&o._db.table("messagesFrom").readAndDelete().then(function(t){t.forEach(function(t){o.trigger("clientMessage",t)})})})})}),t.messageFrom=function(t){var n=this;this._db.then(function(){var e=n._db.table("messagesFrom");e.addRows([t])}).fail(function(t){console.log("ERROR "+t)})},t.messageTo=function(t){var n=this;this._db.then(function(){var e=n._db.table("messagesTo");e.addRows([t])}).fail(function(t){console.log("ERROR "+t)})}}(this)},f=function(t,n,e,i,o,r,s,a){if(!(this instanceof f))return new f(t,n,e,i,o,r,s,a);var c=[t,n,e,i,o,r,s,a];if(this.__factoryClass){var u,h=this;if(this.__factoryClass.forEach(function(t){u=t.apply(h,c)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=f._classInfo.name)return new u(t,n,e,i,o,r,s,a)}else if(u)return u}if(this.__traitInit){var h=this;this.__traitInit.forEach(function(t){t.apply(h,c)})}else"function"==typeof this.init&&this.init.apply(this,c)};f._classInfo={name:"_tcpEmu"},f.prototype=new c,"undefined"!=typeof window&&(window._tcpEmu=f),"undefined"!=typeof window&&(window._tcpEmu_prototype=c);var u=function(){!function(t){var n,e,i,o,r;t.add=function(t,n,i){if(n||i){var o;"[object Array]"===Object.prototype.toString.call(i)?o=i:(o=Array.prototype.slice.call(arguments,2),o||(o=[])),e.push([n,t,o])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),o[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,s;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},o={},r=[];var a=0,c=function(){for(var n,s=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<r.length;f++){var u=r[f];u()}for(var h in i)if(i.hasOwnProperty(h)){var _=i[h];_[0](_[1]),delete i[h]}for(var h in o)if(o.hasOwnProperty(h)){var _=o[h];_.nextTime<s&&(_.fn(),_.nextTime=s+_.step),_.until&&_.until<s&&delete o[h]}t(c),a=s};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){r.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=r.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),r.splice(n,1),!0):!1}}(this)},h=function(t,n,e,i,o,r,s,a){if(!(this instanceof h))return new h(t,n,e,i,o,r,s,a);var c=[t,n,e,i,o,r,s,a];if(this.__factoryClass){var f,u=this;if(this.__factoryClass.forEach(function(t){f=t.apply(u,c)}),"[object Function]"==Object.prototype.toString.call(f)){if(f._classInfo.name!=h._classInfo.name)return new f(t,n,e,i,o,r,s,a)}else if(f)return f}if(this.__traitInit){var u=this;this.__traitInit.forEach(function(t){t.apply(u,c)})}else"function"==typeof this.init&&this.init.apply(this,c)};h._classInfo={name:"later"},h.prototype=new u;var _=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.delegateToRoom=function(t,e,i){var o=this._roomPrefix+":"+t;if(n&&n[o]){var r=this;n[o].forEach(function(t){t!=r&&t.emit(e,i)})}},t.disconnect=function(){var t=this;t._disconnected=!0,t.leaveFromRooms(),t.trigger("disconnect",t),t._disconnected=!0;var n=this._tcp._dbName;a().clearDatabases(function(t){return t.name==n?!0:void 0})},t.emit=function(t,n){this._tcp.messageFrom({name:t,data:n})},t.getId=function(){return this._tcp._socketId},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){var e=this;this._roomPrefix=n.getPrefix(),this._tcp=t,this._server=n;t.on("serverMessage",function(t,n){return e._disconnected?void 0:n.disconnect?void e.disconnect():void e.trigger(n.name,n.data)}),this.broadcast={to:function(t){return{emit:function(n,i){e.delegateToRoom(t,n,i)}}}}}),t.isConnected=function(){return this._disconnected?!1:!0},t.join=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]),n[i].indexOf(this)<0&&(n[i].push(this),e||(e={}),e[this.getId()]||(e[this.getId()]=[]),e[this.getId()].push(t))},t.leave=function(t){var i=this._roomPrefix+":"+t;n||(n={}),n[i]||(n[i]=[]);var o;if((o=n[i].indexOf(this))>=0){n[i].splice(o,1);var r=this.getId(),s=e[r].indexOf(t);s>=0&&e[r].splice(s,1)}},t.leaveFromRooms=function(){var t=this.getId(),n=this;e&&e[t]&&e[t].forEach(function(t){n.leave(t)})},t.removeListener=function(){}}(this)},l=function(t,n,e,i,o,r,s,a){if(!(this instanceof l))return new l(t,n,e,i,o,r,s,a);var c=[t,n,e,i,o,r,s,a];if(this.__factoryClass){var f,u=this;if(this.__factoryClass.forEach(function(t){f=t.apply(u,c)}),"[object Function]"==Object.prototype.toString.call(f)){if(f._classInfo.name!=l._classInfo.name)return new f(t,n,e,i,o,r,s,a)}else if(f)return f}if(this.__traitInit){var u=this;this.__traitInit.forEach(function(t){t.apply(u,c)})}else"function"==typeof this.init&&this.init.apply(this,c)};l._classInfo={name:"_serverSocketWrap"},l.prototype=new _,"undefined"!=typeof window&&(window._serverSocketWrap=l),"undefined"!=typeof window&&(window._serverSocketWrap_prototype=_),function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},_socketEmu=function(t,n,e,i,o,r,s,a){if(!(this instanceof _socketEmu))return new _socketEmu(t,n,e,i,o,r,s,a);var c=[t,n,e,i,o,r,s,a];if(this.__factoryClass){var f,u=this;if(this.__factoryClass.forEach(function(t){f=t.apply(u,c)}),"[object Function]"==Object.prototype.toString.call(f)){if(f._classInfo.name!=_socketEmu._classInfo.name)return new f(t,n,e,i,o,r,s,a)}else if(f)return f}if(this.__traitInit){var u=this;this.__traitInit.forEach(function(t){t.apply(u,c)})}else"function"==typeof this.init&&this.init.apply(this,c)};_socketEmu._classInfo={name:"_socketEmu"},_socketEmu.prototype=new _socketEmu_prototype,"undefined"!=typeof window&&(window._socketEmu=_socketEmu),"undefined"!=typeof window&&(window._socketEmu_prototype=_socketEmu_prototype);